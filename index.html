<!DOCTYPE html>
<html lang="lo" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Manager System (Connected)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@300;400;600&family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Sarabun', sans-serif; transition: background-color 0.3s, color 0.3s; }
        :lang(lo) { font-family: 'Noto Sans Lao', 'Sarabun', sans-serif; }
        .fa, .fas, .far, .fab { font-family: "Font Awesome 6 Free", "Font Awesome 6 Brands" !important; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .btn-hover:hover { filter: brightness(110%); transform: translateY(-2px); }
        
        /* Loading Overlay */
        #loadingOverlay {
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 9999;
        }
        .dark #loadingOverlay {
            background-color: rgba(17, 24, 39, 0.8);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-[#f3f4f6] dark:bg-gray-900 dark:text-gray-100 transition-colors duration-300">

    <div id="loadingOverlay" class="fixed inset-0 flex flex-col items-center justify-center hidden">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600 mb-4"></div>
        <span id="loadingText" class="text-indigo-600 dark:text-indigo-400 font-bold">Loading data...</span>
    </div>

    <nav class="bg-white dark:bg-gray-800 shadow-md sticky top-0 z-50 transition-colors duration-300">
        <div class="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
            
            <div class="flex items-center space-x-3">
                <img id="navLogo" src="" alt="Logo" class="h-10 w-10 object-cover rounded-full border border-gray-200 dark:border-gray-700">
                <span id="navAppName" class="font-bold text-lg text-gray-800 dark:text-white hidden sm:block">MyLinks App</span>
            </div>

            <div class="flex items-center space-x-2 sm:space-x-3">
                <button onclick="cycleLanguage()" id="langToggleBtn" class="flex items-center space-x-2 bg-gray-100 dark:bg-gray-700 px-3 py-1.5 rounded-full hover:bg-gray-200 dark:hover:bg-gray-600 transition border border-gray-200 dark:border-gray-600 shadow-sm mr-2">
                    <img id="currentLangFlag" src="https://flagcdn.com/w40/la.png" class="w-5 h-5 rounded-full object-cover shadow-sm">
                    <span id="currentLangText" class="text-xs font-bold text-gray-700 dark:text-gray-200">LA</span>
                </button>

                <button onclick="toggleTheme()" class="w-10 h-10 flex items-center justify-center rounded-full hover:bg-gray-100 dark:hover:bg-gray-700 transition text-gray-600 dark:text-yellow-300 border border-transparent hover:border-gray-200 dark:hover:border-gray-600">
                    <i id="themeIcon" class="fa-solid fa-moon"></i>
                </button>

                <button id="navLoginBtn" onclick="showPage('login')" class="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800 dark:hover:text-indigo-300 font-medium transition hidden text-sm sm:text-base">
                    <i class="fa-solid fa-right-to-bracket mr-1"></i> <span data-i18n="nav_login">Login</span>
                </button>
                <button id="navAdminBtn" onclick="showPage('admin')" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white font-medium transition hidden mr-2 text-sm sm:text-base">
                    <i class="fa-solid fa-gear mr-1"></i> <span data-i18n="nav_admin">Admin</span>
                </button>
                <button id="navHomeBtn" onclick="showPage('home')" class="text-gray-600 dark:text-gray-300 hover:text-gray-900 dark:hover:text-white font-medium transition hidden mr-2 text-sm sm:text-base">
                    <i class="fa-solid fa-house mr-1"></i> <span data-i18n="nav_home">Home</span>
                </button>
                <button id="navLogoutBtn" onclick="logout()" class="text-red-500 hover:text-red-700 font-medium transition hidden text-sm sm:text-base">
                    <i class="fa-solid fa-right-from-bracket mr-1"></i> <span data-i18n="nav_logout">Logout</span>
                </button>
            </div>
        </div>
    </nav>

    <main class="flex-grow container mx-auto px-4 py-8 max-w-4xl">

        <section id="homePage" class="fade-in block">
            <div class="text-center mb-8">
                <h1 id="siteHeader" class="text-4xl font-bold mb-2 transition-colors">Welcome</h1>
                <p class="text-gray-500 dark:text-gray-400" data-i18n="home_desc">All your links in one place</p>
            </div>

            <div class="flex justify-end mb-4 max-w-2xl mx-auto">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-1 inline-flex border border-gray-100 dark:border-gray-700">
                    <button onclick="setLayout('grid')" id="btnGrid" class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors flex items-center bg-indigo-100 text-indigo-700 dark:bg-indigo-900/50 dark:text-indigo-300">
                        <i class="fa-solid fa-border-all mr-1.5"></i> <span data-i18n="btn_grid">Grid</span>
                    </button>
                    <button onclick="setLayout('list')" id="btnList" class="px-3 py-1.5 rounded-md text-sm font-medium transition-colors flex items-center text-gray-500 hover:text-gray-900 dark:text-gray-400 dark:hover:text-white">
                        <i class="fa-solid fa-list mr-1.5"></i> <span data-i18n="btn_list">List</span>
                    </button>
                </div>
            </div>

            <div id="publicLinksContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-2xl mx-auto transition-all duration-300"></div>
        </section>

        <section id="loginPage" class="hidden fade-in">
            <div class="max-w-sm mx-auto bg-white dark:bg-gray-800 p-8 rounded-xl shadow-lg mt-10 transition-colors duration-300">
                <div class="text-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800 dark:text-white" data-i18n="login_header">Admin Login</h2>
                    <p class="text-sm text-gray-500 dark:text-gray-400" data-i18n="login_sub">Admin Panel</p>
                </div>
                <form onsubmit="handleLogin(event)">
                    <div class="mb-4">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" data-i18n="label_username">Username</label>
                        <input type="text" id="username" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label class="block text-gray-700 dark:text-gray-300 text-sm font-bold mb-2" data-i18n="label_password">Password</label>
                        <input type="password" id="password" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg transition duration-300" data-i18n="btn_confirm">Login</button>
                </form>
                <p id="loginError" class="text-red-500 text-sm text-center mt-3 hidden" data-i18n="login_error">Invalid username or password</p>
                <div class="mt-4 text-center">
                    <button type="button" onclick="showPage('home')" class="text-sm text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white underline" data-i18n="btn_back_home">Back to Home</button>
                </div>
            </div>
        </section>

        <section id="adminPage" class="hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800 dark:text-white" data-i18n="admin_header">Data Management</h2>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 mb-6 border border-gray-100 dark:border-gray-700 transition-colors duration-300">
                <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 mb-4 border-b dark:border-gray-700 pb-2"><i class="fa-solid fa-palette mr-2"></i><span data-i18n="settings_title">Settings</span></h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="label_app_name">Website Name</label>
                        <input type="text" id="configAppName" class="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md font-bold">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2" data-i18n="label_header_text">Header Text</label>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <span class="text-xs text-gray-500 dark:text-gray-400 mb-1 block"><i class="fa-solid fa-language mr-1"></i>ພາສາລາວ (Lao)</span>
                                <input type="text" id="configHeaderTextLO" class="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md" oninput="updateConfigPreview()">
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 dark:text-gray-400 mb-1 block"><i class="fa-solid fa-language mr-1"></i>ภาษาไทย (Thai)</span>
                                <input type="text" id="configHeaderTextTH" class="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md" oninput="updateConfigPreview()">
                            </div>
                            <div>
                                <span class="text-xs text-gray-500 dark:text-gray-400 mb-1 block"><i class="fa-solid fa-language mr-1"></i>English</span>
                                <input type="text" id="configHeaderTextEN" class="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md" oninput="updateConfigPreview()">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="label_header_color">Header Color</label>
                        <div class="flex items-center space-x-2">
                            <input type="color" id="configHeaderColor" class="h-10 w-20 border rounded cursor-pointer" oninput="updateConfigPreview()">
                            <span id="colorValue" class="text-sm text-gray-500 dark:text-gray-400"></span>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="label_logo_url">Logo URL</label>
                        <div class="flex space-x-2">
                            <input type="url" id="configLogoUrl" class="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md" onchange="updateConfigPreview()">
                            <div class="w-12 h-10 border dark:border-gray-600 rounded bg-gray-50 dark:bg-gray-600 flex items-center justify-center overflow-hidden flex-shrink-0">
                                <img id="previewLogo" src="" class="h-full w-auto object-contain">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-6 flex justify-end">
                     <button onclick="saveData()" class="bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 text-sm font-medium transition flex items-center shadow-sm">
                        <i class="fa-solid fa-save mr-2"></i> <span data-i18n="btn_save_config">Save Settings</span>
                    </button>
                </div>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm p-6 mb-6 border border-gray-100 dark:border-gray-700 ring-2 ring-transparent transition-all duration-300" id="formSection">
                <div class="flex justify-between items-center border-b dark:border-gray-700 pb-2 mb-4">
                    <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200" id="formTitle"><i class="fa-solid fa-plus-circle mr-2"></i><span data-i18n="add_btn_title">Add New Button</span></h3>
                    <button id="cancelEditBtn" onclick="cancelEdit()" class="text-sm text-gray-500 dark:text-gray-400 hover:text-red-500 hidden">
                        <i class="fa-solid fa-times"></i> <span data-i18n="cancel_edit">Cancel</span>
                    </button>
                </div>
                
                <form onsubmit="handleLinkSubmit(event)" class="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                    <input type="hidden" id="editLinkId">
                    <div class="md:col-span-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="label_btn_name">Button Label</label>
                        <input type="text" id="newLabel" class="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-green-400" required>
                    </div>
                    <div class="md:col-span-5">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="label_url">URL</label>
                        <input type="url" id="newUrl" class="w-full px-3 py-2 border dark:border-gray-600 dark:bg-gray-700 dark:text-white rounded-md focus:ring-2 focus:ring-green-400" required>
                    </div>
                    <div class="md:col-span-1">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1" data-i18n="label_btn_color">Color</label>
                        <input type="color" id="newColor" class="w-full h-10 border rounded cursor-pointer" value="#3b82f6">
                    </div>
                    <div class="md:col-span-2">
                        <button type="submit" id="submitLinkBtn" class="w-full bg-green-600 text-white py-2 rounded-lg hover:bg-green-700 transition shadow-sm flex items-center justify-center">
                            <i class="fa-solid fa-plus mr-1"></i> <span data-i18n="btn_add">Add</span>
                        </button>
                    </div>
                </form>
            </div>

            <div class="bg-white dark:bg-gray-800 rounded-xl shadow-sm overflow-hidden border border-gray-100 dark:border-gray-700 transition-colors duration-300">
                 <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-200 p-4 bg-gray-50 dark:bg-gray-700 border-b dark:border-gray-600" data-i18n="table_header">Current Buttons</h3>
                 <div class="overflow-x-auto">
                     <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                         <tbody id="adminLinksTable" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                     </table>
                     <div id="emptyState" class="text-center py-8 text-gray-400 dark:text-gray-500 hidden" data-i18n="empty_state">No buttons found</div>
                 </div>
            </div>
        </section>
    </main>

    <footer class="text-center py-6 text-gray-400 text-sm">© 2024 Link Manager System. All rights reserved.</footer>

    <script>
        // --- API CONFIGURATION ---
        const API_URL = "https://script.google.com/macros/s/AKfycbxMoXSejlg9m28pkjQ2-y1lXlsI_dWIY6_MkQ0SEJKtiPLmVduYuEftfw6g7JbFVW5b/exec";

        // --- TRANSLATION DATA ---
        const TRANSLATIONS = {
            lo: {
                nav_login: "ເຂົ້າສູ່ລະບົບ", nav_admin: "ຈັດການຂໍ້ມູນ", nav_home: "ໜ້າຫຼັກ", nav_logout: "ອອກຈາກລະບົບ",
                home_desc: "ລວມລິ້ງທີ່ໜ້າສົນໃຈໄວ້ບ່ອນດຽວ", btn_grid: "ຕາຕະລາງ", btn_list: "ລາຍການ",
                login_header: "ເຂົ້າສູ່ລະບົບ", login_sub: "Admin Panel", label_username: "ຊື່ຜູ້ໃຊ້", label_password: "ລະຫັດຜ່ານ",
                ph_username: "ກະລຸນາໃສ່ຊື່ຜູ້ໃຊ້", ph_password: "ກະລຸນາໃສ່ລະຫັດຜ່ານ", btn_confirm: "ຢືນຢັນ",
                login_error: "ຊື່ຜູ້ໃຊ້ ຫຼື ລະຫັດຜ່ານບໍ່ຖືກຕ້ອງ", btn_back_home: "ກັບໄປໜ້າຫຼັກ", admin_header: "ຈັດການຂໍ້ມູນ (Admin)",
                settings_title: "ຕັ້ງຄ່າທົ່ວໄປ", label_app_name: "ຊື່ເວັບໄຊ (Navbar)", label_header_text: "ຂໍ້ຄວາມຫົວຂໍ້ເວັບໄຊ (ແຕ່ລະພາສາ)",
                label_header_color: "ສີຕົວໜັງສືຫົວຂໍ້", label_logo_url: "URL ໂລໂກ້", btn_save_config: "ບັນທຶກການຕັ້ງຄ່າ",
                saved_msg: "ບັນທຶກແລ້ວ", add_btn_title: "ເພີ່ມປຸ່ມໃໝ່", edit_btn_title: "ແກ້ໄຂປຸ່ມ", cancel_edit: "ຍົກເລີກ",
                label_btn_name: "ຊື່ປຸ່ມ (Label)", label_url: "ລິ້ງ URL", label_btn_color: "ສີປຸ່ມ", btn_add: "ເພີ່ມ", btn_save_edit: "ບັນທึก",
                table_header: "ລາຍການປຸ່ມປະຈຸບັນ", th_example: "ຕົວຢ່າງ", th_name: "ຊື່ປຸ່ມ", th_url: "URL", th_manage: "ຈັດການ",
                btn_edit: "ແກ້ໄຂ", btn_delete: "ລຶບ", empty_state: "ຍັງບໍ່ມີຂໍ້ມູນປຸ່ມ", confirm_delete: "ທ່ານຕ້ອງການລຶບປຸ່ມນີ້ບໍ່?",
                alert_header_req: "ກະລຸນາໃສ່ຂໍ້ຄວາມຫົວຂໍ້", alert_saved: "ບັນທຶກລົງ Google Sheet ແລ້ວ"
            },
            th: {
                nav_login: "เข้าสู่ระบบ", nav_admin: "จัดการหลังบ้าน", nav_home: "หน้าหลัก", nav_logout: "ออกจากระบบ",
                home_desc: "รวมลิงก์ที่น่าสนใจไว้ในที่เดียว", btn_grid: "ตาราง", btn_list: "รายการ",
                login_header: "เข้าสู่ระบบหลังบ้าน", login_sub: "Admin Panel", label_username: "Username", label_password: "Password",
                ph_username: "กรอกชื่อผู้ใช้", ph_password: "กรอกรหัสผ่าน", btn_confirm: "ยืนยันตัวตน",
                login_error: "ชื่อผู้ใช้หรือรหัสผ่านไม่ถูกต้อง", btn_back_home: "กลับไปหน้าหลัก", admin_header: "จัดการข้อมูล (Admin)",
                settings_title: "ตั้งค่าทั่วไป", label_app_name: "ชื่อเว็บไซต์ (Navbar)", label_header_text: "ข้อความหัวข้อเว็บไซต์ (แต่ละภาษา)",
                label_header_color: "สีตัวหนังสือหัวข้อ", label_logo_url: "URL โลโก้", btn_save_config: "บันทึกการตั้งค่า",
                saved_msg: "บันทึกแล้ว", add_btn_title: "เพิ่มปุ่มใหม่", edit_btn_title: "แก้ไขปุ่ม", cancel_edit: "ยกเลิกการแก้ไข",
                label_btn_name: "ชื่อปุ่ม (Label)", label_url: "ลิงก์ URL", label_btn_color: "สีปุ่ม", btn_add: "เพิ่ม", btn_save_edit: "บันทึกการแก้ไข",
                table_header: "รายการปุ่มปัจจุบัน", th_example: "ตัวอย่าง", th_name: "ชื่อปุ่ม", th_url: "URL", th_manage: "จัดการ",
                btn_edit: "แก้ไข", btn_delete: "ลบ", empty_state: "ยังไม่มีข้อมูลปุ่ม", confirm_delete: "คุณต้องการลบปุ่มนี้ใช่หรือไม่?",
                alert_header_req: "กรุณาใส่ข้อความหัวข้อให้ครบ", alert_saved: "บันทึกลง Google Sheet แล้ว"
            },
            en: {
                nav_login: "Login", nav_admin: "Admin", nav_home: "Home", nav_logout: "Logout",
                home_desc: "All your links in one place", btn_grid: "Grid", btn_list: "List",
                login_header: "Admin Login", login_sub: "Admin Panel", label_username: "Username", label_password: "Password",
                ph_username: "Enter username", ph_password: "Enter password", btn_confirm: "Login",
                login_error: "Invalid username or password", btn_back_home: "Back to Home", admin_header: "Data Management",
                settings_title: "General Settings", label_app_name: "Website Name", label_header_text: "Header Text (Multi-Lang)",
                label_header_color: "Header Color", label_logo_url: "Logo URL", btn_save_config: "Save Settings",
                saved_msg: "Saved", add_btn_title: "Add New Button", edit_btn_title: "Edit Button", cancel_edit: "Cancel",
                label_btn_name: "Button Label", label_url: "Link URL", label_btn_color: "Button Color", btn_add: "Add",
                btn_save_edit: "Save Changes", table_header: "Current Buttons", th_example: "Example", th_name: "Name",
                th_url: "URL", th_manage: "Manage", btn_edit: "Edit", btn_delete: "Delete", empty_state: "No buttons found",
                confirm_delete: "Delete this button?", alert_header_req: "Enter header text", alert_saved: "Saved to Google Sheet"
            }
        };

        let currentLang = 'lo'; 
        const LANG_ORDER = ['lo', 'th', 'en'];
        const LANG_DISPLAY = {
            'lo': { abbr: 'LA', flag: 'https://flagcdn.com/w40/la.png' },
            'th': { abbr: 'TH', flag: 'https://flagcdn.com/w40/th.png' },
            'en': { abbr: 'EN', flag: 'https://flagcdn.com/w40/gb.png' }
        };

        const DEFAULT_DATA = {
            config: {
                appName: "MyLinks App",
                headerText: { lo: "ຍິນດີຕ້ອນຮັບ", th: "ยินดีต้อนรับ", en: "Welcome" },
                headerColor: "#1f2937",
                logoUrl: "https://lh3.googleusercontent.com/d/1vXP8vomYGQUwJ4Pisavo_7Mb9uAKJOGV"
            },
            links: []
        };

        let appData = { ...DEFAULT_DATA };
        let isLoggedIn = sessionStorage.getItem('myLinkApp_Login') === 'true';

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            loadDataFromApi();
            updateNav();
            setLayout('grid');
        });

        // --- API FUNCTIONS ---
        function loadDataFromApi() {
            showLoading(true, "Connecting to Google Sheet...");
            fetch(API_URL)
            .then(response => response.json())
            .then(data => {
                // Merge loaded data with defaults to ensure structure
                appData = {
                    config: { ...DEFAULT_DATA.config, ...data.config },
                    links: data.links || []
                };
                // Ensure headerText is object
                if (typeof appData.config.headerText === 'string') {
                    const txt = appData.config.headerText;
                    appData.config.headerText = { lo: txt, th: txt, en: txt };
                }
                
                changeLanguage(currentLang); // Re-render with data
            })
            .catch(error => {
                console.error('Error loading data:', error);
                alert("Cannot load data from Google Sheet. Using defaults.");
                appData = DEFAULT_DATA;
                changeLanguage(currentLang);
            })
            .finally(() => {
                showLoading(false);
            });
        }

        function saveData() {
            // Get values from inputs first
            const appName = document.getElementById('configAppName').value;
            const textLO = document.getElementById('configHeaderTextLO').value;
            const textTH = document.getElementById('configHeaderTextTH').value;
            const textEN = document.getElementById('configHeaderTextEN').value;
            const color = document.getElementById('configHeaderColor').value;
            const logo = document.getElementById('configLogoUrl').value;
            
            // Validate
            if(!textLO && !textTH && !textEN) return alert(TRANSLATIONS[currentLang].alert_header_req);

            // Update appData object
            appData.config.headerText = { lo: textLO, th: textTH, en: textEN };
            appData.config.appName = appName;
            appData.config.headerColor = color;
            appData.config.logoUrl = logo;

            showLoading(true, "Saving to Google Sheet...");
            
            // Send POST request
            fetch(API_URL, {
                method: 'POST',
                mode: 'no-cors', // Google Script WebApp requirement for simple POST
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(appData)
            })
            .then(() => {
                // Since mode is no-cors, we can't read response, assume success if no error
                const btn = document.querySelector('button[onclick="saveData()"]');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = `<i class="fa-solid fa-check"></i> <span>${TRANSLATIONS[currentLang].alert_saved}</span>`;
                btn.classList.add('bg-green-600');
                renderApp(); // Update UI
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.classList.remove('bg-green-600');
                }, 3000);
            })
            .catch(error => {
                console.error('Error saving data:', error);
                alert("Error saving data. Please try again.");
            })
            .finally(() => {
                showLoading(false);
            });
        }

        function showLoading(show, text = "Loading...") {
            const overlay = document.getElementById('loadingOverlay');
            const txt = document.getElementById('loadingText');
            if (show) {
                txt.innerText = text;
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        // --- LANGUAGE & UI LOGIC ---
        function cycleLanguage() {
            let currentIndex = LANG_ORDER.indexOf(currentLang);
            let nextIndex = (currentIndex + 1) % LANG_ORDER.length;
            changeLanguage(LANG_ORDER[nextIndex]);
        }

        function changeLanguage(lang) {
            currentLang = lang;
            document.documentElement.lang = lang;

            // Update translations
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key !== 'nav_app_name' && TRANSLATIONS[lang][key]) {
                    el.innerText = TRANSLATIONS[lang][key];
                }
            });

            // Update placeholders
            document.getElementById('username').placeholder = TRANSLATIONS[lang]['ph_username'];
            document.getElementById('password').placeholder = TRANSLATIONS[lang]['ph_password'];
            document.getElementById('newLabel').placeholder = (lang === 'en') ? "Ex: Google" : "Google";

            // Update Single Button UI
            document.getElementById('currentLangFlag').src = LANG_DISPLAY[lang].flag;
            document.getElementById('currentLangText').innerText = LANG_DISPLAY[lang].abbr;

            renderApp(); 
        }

        function renderApp() {
            // App Name & Title
            const appName = appData.config.appName || "MyLinks App";
            document.getElementById('navAppName').innerText = appName;
            document.title = appName;

            // Header Text
            const header = document.getElementById('siteHeader');
            const textObj = appData.config.headerText || {};
            header.innerText = textObj[currentLang] || textObj['lo'] || "Welcome";
            header.style.color = appData.config.headerColor;
            
            // Logo
            const logoUrl = appData.config.logoUrl || "https://lh3.googleusercontent.com/d/1vXP8vomYGQUwJ4Pisavo_7Mb9uAKJOGV"; 
            document.getElementById('navLogo').src = logoUrl;

            // Admin Inputs
            if (isLoggedIn) {
                document.getElementById('configAppName').value = appName;
                document.getElementById('configHeaderTextLO').value = textObj['lo'] || '';
                document.getElementById('configHeaderTextTH').value = textObj['th'] || '';
                document.getElementById('configHeaderTextEN').value = textObj['en'] || '';
                document.getElementById('configHeaderColor').value = appData.config.headerColor;
                document.getElementById('configLogoUrl').value = logoUrl;
                document.getElementById('previewLogo').src = logoUrl;
                renderAdminTable();
            }

            // Public Links
            renderPublicLinks();
        }

        function renderPublicLinks() {
            const container = document.getElementById('publicLinksContainer');
            container.innerHTML = '';
            appData.links.forEach(link => {
                const a = document.createElement('a');
                a.href = link.url;
                a.target = "_blank";
                a.className = "btn-hover block w-full py-4 px-6 rounded-xl text-white text-center font-bold text-lg shadow-md transition-all duration-300 flex items-center justify-center space-x-2";
                a.style.backgroundColor = link.color;
                a.innerHTML = `<span>${link.label}</span> <i class="fa-solid fa-arrow-up-right-from-square text-sm opacity-70"></i>`;
                container.appendChild(a);
            });
        }

        function renderAdminTable() {
            const tbody = document.getElementById('adminLinksTable');
            tbody.innerHTML = '';
            
            if(appData.links.length === 0) {
                document.getElementById('emptyState').classList.remove('hidden');
            } else {
                document.getElementById('emptyState').classList.add('hidden');
                appData.links.forEach(link => {
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap"><div class="w-8 h-8 rounded-full shadow-sm border border-gray-200" style="background-color: ${link.color}"></div></td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-gray-100">${link.label}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 truncate max-w-xs"><a href="${link.url}" target="_blank" class="hover:text-indigo-600 underline">${link.url}</a></td>
                        <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                             <div class="flex justify-end space-x-2">
                                <button onclick="startEdit(${link.id})" class="text-amber-600 bg-amber-50 px-3 py-1 rounded-md border border-amber-200"><i class="fa-solid fa-pen"></i> ${TRANSLATIONS[currentLang].btn_edit}</button>
                                <button onclick="deleteLink(${link.id})" class="text-red-600 bg-red-50 px-3 py-1 rounded-md border border-red-200"><i class="fa-solid fa-trash"></i> ${TRANSLATIONS[currentLang].btn_delete}</button>
                            </div>
                        </td>
                    `;
                    tbody.appendChild(tr);
                });
            }
        }

        // --- AUTH, EDIT, DELETE, THEME ---
        function handleLogin(e) {
            e.preventDefault();
            if (document.getElementById('username').value === 'admin' && document.getElementById('password').value === '123') {
                isLoggedIn = true;
                sessionStorage.setItem('myLinkApp_Login', 'true');
                document.getElementById('username').value = ''; document.getElementById('password').value = '';
                showPage('admin');
            } else { document.getElementById('loginError').classList.remove('hidden'); }
        }
        function logout() { isLoggedIn = false; sessionStorage.removeItem('myLinkApp_Login'); showPage('home'); }
        function showPage(pageId) {
            ['homePage', 'loginPage', 'adminPage'].forEach(id => document.getElementById(id).classList.add('hidden'));
            if(pageId === 'admin' && !isLoggedIn) return showPage('login');
            if(pageId === 'login' && isLoggedIn) return showPage('admin');
            document.getElementById(pageId === 'admin' ? 'adminPage' : (pageId === 'login' ? 'loginPage' : 'homePage')).classList.remove('hidden');
            updateNav();
            renderApp();
        }
        function updateNav() {
            const login = document.getElementById('navLoginBtn'), logout = document.getElementById('navLogoutBtn'), admin = document.getElementById('navAdminBtn'), home = document.getElementById('navHomeBtn');
            if(isLoggedIn) { login.classList.add('hidden'); logout.classList.remove('hidden'); admin.classList.remove('hidden'); home.classList.remove('hidden'); }
            else { login.classList.remove('hidden'); logout.classList.add('hidden'); admin.classList.add('hidden'); home.classList.add('hidden'); }
        }
        function handleLinkSubmit(e) {
            e.preventDefault();
            const id = document.getElementById('editLinkId').value;
            const label = document.getElementById('newLabel').value;
            const url = document.getElementById('newUrl').value;
            const color = document.getElementById('newColor').value;
            if(id) { const idx = appData.links.findIndex(l => l.id == id); if(idx !== -1) appData.links[idx] = { ...appData.links[idx], label, url, color }; }
            else { appData.links.push({ id: Date.now(), label, url, color }); }
            saveData(); cancelEdit();
        }
        function startEdit(id) {
            const link = appData.links.find(l => l.id === id); if(!link) return;
            document.getElementById('editLinkId').value = link.id; document.getElementById('newLabel').value = link.label;
            document.getElementById('newUrl').value = link.url; document.getElementById('newColor').value = link.color;
            const t = TRANSLATIONS[currentLang];
            document.getElementById('formTitle').innerHTML = `<i class="fa-solid fa-pen-to-square mr-2"></i><span>${t.edit_btn_title}</span>`;
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            const btn = document.getElementById('submitLinkBtn');
            btn.innerHTML = `<i class="fa-solid fa-save mr-1"></i> <span>${t.btn_save_edit}</span>`;
            btn.classList.replace('bg-green-600', 'bg-amber-500'); btn.classList.replace('hover:bg-green-700', 'hover:bg-amber-600');
            document.getElementById('formSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        function cancelEdit() {
            document.getElementById('editLinkId').value = ''; document.getElementById('newLabel').value = '';
            document.getElementById('newUrl').value = ''; document.getElementById('newColor').value = '#3b82f6';
            const t = TRANSLATIONS[currentLang];
            document.getElementById('formTitle').innerHTML = `<i class="fa-solid fa-plus-circle mr-2"></i><span>${t.add_btn_title}</span>`;
            document.getElementById('cancelEditBtn').classList.add('hidden');
            const btn = document.getElementById('submitLinkBtn');
            btn.innerHTML = `<i class="fa-solid fa-plus mr-1"></i> <span>${t.btn_add}</span>`;
            btn.classList.replace('bg-amber-500', 'bg-green-600'); btn.classList.replace('hover:bg-amber-600', 'hover:bg-green-700');
        }
        function deleteLink(id) { if(confirm(TRANSLATIONS[currentLang].confirm_delete)) { if(document.getElementById('editLinkId').value == id) cancelEdit(); appData.links = appData.links.filter(l => l.id !== id); saveData(); } }
        function setLayout(mode) {
            const c = document.getElementById('publicLinksContainer'), g = document.getElementById('btnGrid'), l = document.getElementById('btnList');
            if(mode === 'grid') { c.classList.add('md:grid-cols-2'); g.classList.add('bg-indigo-100','text-indigo-700'); l.classList.remove('bg-indigo-100','text-indigo-700'); }
            else { c.classList.remove('md:grid-cols-2'); l.classList.add('bg-indigo-100','text-indigo-700'); g.classList.remove('bg-indigo-100','text-indigo-700'); }
        }
        function updateConfigPreview() { document.getElementById('colorValue').innerText = document.getElementById('configHeaderColor').value; document.getElementById('previewLogo').src = document.getElementById('configLogoUrl').value || ""; }
        function toggleTheme() { document.documentElement.classList.toggle('dark'); }
    </script>
</body>
</html>
